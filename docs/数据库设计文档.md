# 数据库设计文档

> 在线考试报名系统 - 详细数据库设计

---

## 1. 数据库概述

**数据库名称:** `exam_registration_system`

**字符集:** `utf8mb4`

**排序规则:** `utf8mb4_unicode_ci`

**存储引擎:** InnoDB

**表数量:** 6 张核心表

---

## 2. 表结构设计

### 2.1 用户表 (sys_user)

**表说明:** 存储系统所有用户信息,包括考生和管理员

| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | 否 | 自增 | PK | 主键ID |
| username | VARCHAR | 50 | 否 | - | UK | 用户名(手机号) |
| password | VARCHAR | 128 | 否 | - | - | 密码(BCrypt加密) |
| real_name | VARCHAR | 50 | 是 | NULL | - | 真实姓名 |
| id_card | VARCHAR | 64 | 是 | NULL | IDX | 身份证号(AES加密) |
| phone | VARCHAR | 64 | 是 | NULL | IDX | 手机号(AES加密) |
| email | VARCHAR | 100 | 是 | NULL | - | 邮箱 |
| gender | TINYINT | - | 是 | NULL | - | 性别(1-男 2-女) |
| birthday | DATE | - | 是 | NULL | - | 出生日期 |
| avatar | VARCHAR | 255 | 是 | NULL | - | 头像URL |
| education | VARCHAR | 50 | 是 | NULL | - | 学历(高中/大专/本科等) |
| work_unit | VARCHAR | 200 | 是 | NULL | - | 工作单位 |
| address | VARCHAR | 255 | 是 | NULL | - | 联系地址 |
| role | VARCHAR | 20 | 否 | 'user' | IDX | 角色(user-考生/admin-管理员) |
| status | TINYINT | - | 否 | 1 | - | 状态(1-正常 2-禁用) |
| last_login_time | DATETIME | - | 是 | NULL | - | 最后登录时间 |
| last_login_ip | VARCHAR | 50 | 是 | NULL | - | 最后登录IP |
| login_fail_count | INT | - | 否 | 0 | - | 登录失败次数 |
| lock_until | DATETIME | - | 是 | NULL | - | 锁定截止时间 |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | - | 更新时间 |

**索引设计:**
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_username` (`username`)
- INDEX: `idx_id_card` (`id_card`)
- INDEX: `idx_phone` (`phone`)
- INDEX: `idx_role` (`role`)

**字段说明:**
- `id_card` 和 `phone` 需要加密存储,查询时解密
- `password` 使用 BCrypt 加密,不可逆
- `login_fail_count` 用于防暴力破解,超过5次锁定账号
- `lock_until` 锁定截止时间,到期自动解锁

---

### 2.2 考试表 (exam)

**表说明:** 存储考试基本信息

| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | 否 | 自增 | PK | 主键ID |
| exam_name | VARCHAR | 200 | 否 | - | - | 考试名称 |
| exam_type | VARCHAR | 50 | 否 | - | IDX | 考试类型(职业资格/学业水平等) |
| exam_date | DATE | - | 否 | - | IDX | 考试日期 |
| exam_time | VARCHAR | 50 | 否 | - | - | 考试时间段(如:9:00-11:00) |
| registration_start | DATETIME | - | 否 | - | - | 报名开始时间 |
| registration_end | DATETIME | - | 否 | - | - | 报名结束时间 |
| fee | DECIMAL | 10,2 | 否 | 0.00 | - | 报名费用(元) |
| description | TEXT | - | 是 | NULL | - | 考试简介 |
| notice | TEXT | - | 是 | NULL | - | 报名须知 |
| file_url | VARCHAR | 255 | 是 | NULL | - | 考试简章文件URL |
| status | TINYINT | - | 否 | 1 | IDX | 状态(1-草稿 2-已发布 3-报名中 4-报名结束 5-已结束) |
| total_quota | INT | - | 是 | NULL | - | 总报名名额(NULL表示不限) |
| current_count | INT | - | 否 | 0 | - | 当前报名人数 |
| create_by | BIGINT | - | 否 | - | - | 创建人ID |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | - | 更新时间 |

**索引设计:**
- PRIMARY KEY: `id`
- INDEX: `idx_exam_type` (`exam_type`)
- INDEX: `idx_exam_date` (`exam_date`)
- INDEX: `idx_status` (`status`)
- INDEX: `idx_create_time` (`create_time` DESC)

**字段说明:**
- `status` 状态流转: 草稿 → 已发布 → 报名中 → 报名结束 → 已结束
- `current_count` 每次报名成功后 +1,用于统计
- `total_quota` 为 NULL 表示不限制报名人数

---

### 2.3 考点表 (exam_site)

**表说明:** 存储考点信息

| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | 否 | 自增 | PK | 主键ID |
| exam_id | BIGINT | - | 否 | - | FK,IDX | 考试ID |
| site_name | VARCHAR | 200 | 否 | - | - | 考点名称 |
| province | VARCHAR | 50 | 否 | - | IDX | 省份 |
| city | VARCHAR | 50 | 否 | - | IDX | 城市 |
| district | VARCHAR | 50 | 是 | NULL | - | 区/县 |
| address | VARCHAR | 255 | 否 | - | - | 详细地址 |
| contact_person | VARCHAR | 50 | 是 | NULL | - | 联系人 |
| contact_phone | VARCHAR | 20 | 是 | NULL | - | 联系电话 |
| capacity | INT | - | 否 | 100 | - | 容纳人数 |
| current_count | INT | - | 否 | 0 | - | 当前报名人数 |
| longitude | DECIMAL | 10,6 | 是 | NULL | - | 经度(用于地图展示) |
| latitude | DECIMAL | 10,6 | 是 | NULL | - | 纬度(用于地图展示) |
| status | TINYINT | - | 否 | 1 | - | 状态(1-启用 2-禁用) |
| remark | VARCHAR | 500 | 是 | NULL | - | 备注 |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | - | 创建时间 |

**索引设计:**
- PRIMARY KEY: `id`
- FOREIGN KEY: `fk_exam_id` (`exam_id`) REFERENCES `exam`(`id`)
- INDEX: `idx_exam_id` (`exam_id`)
- INDEX: `idx_province_city` (`province`, `city`)

**字段说明:**
- `current_count` 记录已选择该考点的报名人数
- `capacity` 达到上限后不可再选择该考点

---

### 2.4 报名表 (registration)

**表说明:** 存储考生报名记录

| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | 否 | 自增 | PK | 主键ID |
| exam_id | BIGINT | - | 否 | - | FK,IDX | 考试ID |
| user_id | BIGINT | - | 否 | - | FK,IDX | 用户ID |
| exam_site_id | BIGINT | - | 是 | NULL | FK | 考点ID |
| admission_ticket_no | VARCHAR | 50 | 是 | NULL | UK | 准考证号 |
| exam_room | VARCHAR | 20 | 是 | NULL | - | 考场号 |
| seat_no | VARCHAR | 10 | 是 | NULL | - | 座位号 |
| subject | VARCHAR | 100 | 是 | NULL | - | 报考科目 |
| materials | TEXT | - | 是 | NULL | - | 上传材料(JSON格式存储URL数组) |
| audit_status | TINYINT | - | 否 | 1 | IDX | 审核状态(1-待审核 2-审核通过 3-审核驳回) |
| audit_remark | VARCHAR | 500 | 是 | NULL | - | 审核备注/驳回原因 |
| audit_by | BIGINT | - | 是 | NULL | - | 审核人ID |
| audit_time | DATETIME | - | 是 | NULL | - | 审核时间 |
| payment_status | TINYINT | - | 否 | 1 | IDX | 缴费状态(1-未缴费 2-已缴费) |
| payment_time | DATETIME | - | 是 | NULL | - | 缴费时间 |
| ticket_download_count | INT | - | 否 | 0 | - | 准考证下载次数 |
| ticket_download_time | DATETIME | - | 是 | NULL | - | 首次下载时间 |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | IDX | 创建时间 |
| update_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | - | 更新时间 |

**索引设计:**
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_ticket_no` (`admission_ticket_no`)
- FOREIGN KEY: `fk_reg_exam_id` (`exam_id`) REFERENCES `exam`(`id`)
- FOREIGN KEY: `fk_reg_user_id` (`user_id`) REFERENCES `sys_user`(`id`)
- FOREIGN KEY: `fk_reg_site_id` (`exam_site_id`) REFERENCES `exam_site`(`id`)
- INDEX: `idx_exam_id` (`exam_id`)
- INDEX: `idx_user_id` (`user_id`)
- INDEX: `idx_audit_status` (`audit_status`)
- INDEX: `idx_payment_status` (`payment_status`)
- INDEX: `idx_exam_audit` (`exam_id`, `audit_status`)
- INDEX: `idx_create_time` (`create_time` DESC)
- UNIQUE INDEX: `uk_user_exam` (`user_id`, `exam_id`) - 防止重复报名

**字段说明:**
- `materials` 存储JSON格式: `["url1", "url2"]`
- `admission_ticket_no` 格式: `考试代码(4位)+考点代码(4位)+顺序号(6位)` 如: `2024000100001`
- `uk_user_exam` 联合唯一索引,保证一个用户同一场考试只能报名一次

**materials JSON 格式示例:**
```json
{
  "id_card_front": "https://xxx.com/materials/1001_front.jpg",
  "id_card_back": "https://xxx.com/materials/1001_back.jpg",
  "diploma": "https://xxx.com/materials/1001_diploma.pdf",
  "photo": "https://xxx.com/materials/1001_photo.jpg"
}
```

---

### 2.5 缴费订单表 (payment_order)

**表说明:** 存储缴费订单信息

| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | 否 | 自增 | PK | 主键ID |
| order_no | VARCHAR | 64 | 否 | - | UK | 订单号 |
| registration_id | BIGINT | - | 否 | - | FK,IDX | 报名ID |
| user_id | BIGINT | - | 否 | - | FK,IDX | 用户ID |
| exam_id | BIGINT | - | 否 | - | IDX | 考试ID(冗余字段,便于统计) |
| amount | DECIMAL | 10,2 | 否 | - | - | 支付金额(元) |
| payment_method | VARCHAR | 20 | 是 | NULL | - | 支付方式(alipay/wechat/union) |
| transaction_id | VARCHAR | 128 | 是 | NULL | UK | 第三方交易流水号 |
| status | TINYINT | - | 否 | 1 | IDX | 订单状态(1-待支付 2-已支付 3-已关闭 4-已退款) |
| pay_time | DATETIME | - | 是 | NULL | - | 支付时间 |
| expire_time | DATETIME | - | 否 | - | - | 订单过期时间(创建后30分钟) |
| callback_data | TEXT | - | 是 | NULL | - | 支付回调数据(JSON) |
| refund_reason | VARCHAR | 500 | 是 | NULL | - | 退款原因 |
| refund_time | DATETIME | - | 是 | NULL | - | 退款时间 |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | IDX | 创建时间 |
| update_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | - | 更新时间 |

**索引设计:**
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_order_no` (`order_no`)
- UNIQUE KEY: `uk_transaction_id` (`transaction_id`)
- FOREIGN KEY: `fk_pay_reg_id` (`registration_id`) REFERENCES `registration`(`id`)
- FOREIGN KEY: `fk_pay_user_id` (`user_id`) REFERENCES `sys_user`(`id`)
- INDEX: `idx_registration_id` (`registration_id`)
- INDEX: `idx_user_id` (`user_id`)
- INDEX: `idx_exam_id` (`exam_id`)
- INDEX: `idx_status` (`status`)
- INDEX: `idx_create_time` (`create_time` DESC)

**字段说明:**
- `order_no` 格式: `PAY` + `yyyyMMddHHmmss` + `6位随机数` 如: `PAY20241016153000123456`
- `expire_time` = `create_time` + 30分钟
- `transaction_id` 由支付平台返回,用于对账

---

### 2.6 公告表 (notice)

**表说明:** 存储系统公告信息

| 字段名 | 数据类型 | 长度 | 允许NULL | 默认值 | 索引 | 说明 |
|--------|----------|------|----------|--------|------|------|
| id | BIGINT | - | 否 | 自增 | PK | 主键ID |
| title | VARCHAR | 200 | 否 | - | - | 公告标题 |
| content | TEXT | - | 否 | - | - | 公告内容(富文本) |
| type | VARCHAR | 20 | 否 | 'notice' | IDX | 公告类型(notice-通知/policy-政策/exam-考试安排) |
| is_top | TINYINT | - | 否 | 0 | IDX | 是否置顶(0-否 1-是) |
| status | TINYINT | - | 否 | 1 | IDX | 状态(1-已发布 2-已下架) |
| view_count | INT | - | 否 | 0 | - | 浏览次数 |
| publish_time | DATETIME | - | 是 | NULL | - | 发布时间 |
| create_by | BIGINT | - | 否 | - | - | 创建人ID |
| create_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | IDX | 创建时间 |
| update_time | DATETIME | - | 否 | CURRENT_TIMESTAMP | - | 更新时间 |

**索引设计:**
- PRIMARY KEY: `id`
- INDEX: `idx_type` (`type`)
- INDEX: `idx_is_top_status` (`is_top`, `status`)
- INDEX: `idx_create_time` (`create_time` DESC)

**字段说明:**
- `is_top=1` 的公告在列表顶部显示
- `view_count` 每次查看详情时 +1

---

## 3. 数据字典汇总

### 3.1 状态枚举

#### 用户状态 (sys_user.status)
| 值 | 说明 |
|----|------|
| 1 | 正常 |
| 2 | 禁用 |

#### 用户角色 (sys_user.role)
| 值 | 说明 |
|----|------|
| user | 考生 |
| admin | 管理员 |

#### 考试状态 (exam.status)
| 值 | 说明 |
|----|------|
| 1 | 草稿 |
| 2 | 已发布 |
| 3 | 报名中 |
| 4 | 报名结束 |
| 5 | 已结束 |

#### 审核状态 (registration.audit_status)
| 值 | 说明 |
|----|------|
| 1 | 待审核 |
| 2 | 审核通过 |
| 3 | 审核驳回 |

#### 缴费状态 (registration.payment_status)
| 值 | 说明 |
|----|------|
| 1 | 未缴费 |
| 2 | 已缴费 |

#### 订单状态 (payment_order.status)
| 值 | 说明 |
|----|------|
| 1 | 待支付 |
| 2 | 已支付 |
| 3 | 已关闭 |
| 4 | 已退款 |

#### 公告状态 (notice.status)
| 值 | 说明 |
|----|------|
| 1 | 已发布 |
| 2 | 已下架 |

### 3.2 加密字段清单

| 表名 | 字段名 | 加密方式 | 说明 |
|------|--------|----------|------|
| sys_user | password | BCrypt | 不可逆加密 |
| sys_user | id_card | AES | 可逆加密,需要时解密 |
| sys_user | phone | AES | 可逆加密,需要时解密 |

---

## 4. 数据库初始化数据

### 4.1 默认管理员账号

```sql
-- 用户名: admin
-- 密码: admin123 (BCrypt加密后的值)
INSERT INTO sys_user (username, password, real_name, role, status)
VALUES ('admin', '$2a$10$XYZ...', '系统管理员', 'admin', 1);
```

### 4.2 考试类型参考数据

```sql
-- 可以在前端下拉框使用
INSERT INTO dict_type (dict_name, dict_code) VALUES ('考试类型', 'exam_type');

INSERT INTO dict_data (dict_type, dict_label, dict_value, sort_order) VALUES
('exam_type', '职业资格考试', 'vocational', 1),
('exam_type', '学业水平考试', 'academic', 2),
('exam_type', '技能等级考试', 'skill', 3),
('exam_type', '职称考试', 'professional', 4),
('exam_type', '其他', 'other', 99);
```

---

## 5. 性能优化建议

### 5.1 索引优化

1. **查询频率高的字段建立索引**
   - `sys_user.username` (登录)
   - `registration.exam_id` + `audit_status` (审核列表)
   - `payment_order.status` (订单查询)

2. **避免过多索引**
   - 每个表索引数量控制在 5-8 个
   - 更新频繁的字段不建索引

3. **使用联合索引**
   - 遵循最左前缀原则
   - 区分度高的字段放前面

### 5.2 查询优化

1. **分页查询使用 LIMIT**
   ```sql
   SELECT * FROM registration
   WHERE exam_id = ?
   ORDER BY create_time DESC
   LIMIT 0, 20;
   ```

2. **避免 SELECT ***
   ```sql
   -- 只查询需要的字段
   SELECT id, exam_name, exam_date, fee
   FROM exam
   WHERE status = 2;
   ```

3. **使用覆盖索引**
   ```sql
   -- idx_exam_audit (exam_id, audit_status) 覆盖索引
   SELECT COUNT(*)
   FROM registration
   WHERE exam_id = ? AND audit_status = 1;
   ```

### 5.3 表分区 (可选,数据量大时)

```sql
-- 按年份分区 registration 表
ALTER TABLE registration
PARTITION BY RANGE (YEAR(create_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

---

## 6. 备份策略

### 6.1 备份方案

**全量备份:**
- 频率: 每天凌晨 3:00
- 保留: 最近 7 天
- 工具: mysqldump

**增量备份:**
- 频率: 每小时
- 保留: 最近 24 小时
- 方式: binlog

### 6.2 备份命令

```bash
# 全量备份
mysqldump -u root -p \
  --single-transaction \
  --routines \
  --triggers \
  exam_registration_system > backup_$(date +%Y%m%d).sql

# 压缩备份
gzip backup_$(date +%Y%m%d).sql
```

---

**文档版本:** v1.0
**编制日期:** 2025-10-16
