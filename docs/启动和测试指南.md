# 启动和测试指南

本文档介绍如何启动和测试在线考试报名系统。

## 📋 目录

- [环境要求](#环境要求)
- [启动步骤](#启动步骤)
- [API 文档访问](#api-文档访问)
- [功能测试](#功能测试)
- [常见问题](#常见问题)

---

## 环境要求

### 必需软件

| 软件 | 版本要求 | 说明 |
|------|---------|------|
| **Java JDK** | 11 或更高 | 后端运行环境 |
| **Node.js** | 16 或更高 | 前端运行环境 |
| **Docker** | 最新版 | 运行 MySQL 容器 |
| **Docker Compose** | 最新版 | 编排 MySQL 服务 |
| **Maven** | 3.6+ | 构建后端项目 |
| **IntelliJ IDEA** | 2022+ （推荐） | Java 开发IDE |
| **VSCode** | 最新版（推荐） | 前端开发IDE |

### 验证环境

```bash
# 验证 Java 版本
java -version

# 验证 Node.js 版本
node -v
npm -v

# 验证 Docker 版本
docker --version
docker-compose --version

# 验证 Maven 版本
mvn -v
```

---

## 启动步骤

### 1. 启动 MySQL 数据库

```bash
# 进入项目根目录
cd /Users/scguo/OpenSource/exam-registration-system

# 启动 MySQL 容器
docker-compose up -d

# 查看容器状态
docker-compose ps

# 查看日志（确认启动成功）
docker-compose logs mysql

# 验证数据库连接
docker-compose exec mysql mysql -uroot -p123456 -e "USE exam_registration_system; SHOW TABLES;"
```

**预期输出：** 应该看到 6 张表（sys_user, exam, exam_site, registration, payment_order, notice）

### 2. 启动后端服务

#### 方式一：使用 IntelliJ IDEA

1. 打开 IntelliJ IDEA
2. 打开项目：`File` → `Open` → 选择 `backend` 目录
3. 等待 Maven 依赖下载完成
4. 找到主类：`com.exam.ExamRegistrationSystemApplication`
5. 右键 → `Run 'ExamRegistrationSystemApplication'`

#### 方式二：使用 Maven 命令行

```bash
# 进入后端目录
cd backend

# 清理并打包（跳过测试）
mvn clean package -DskipTests

# 启动应用
java -jar target/exam-registration-system-1.0.0.jar

# 或者直接运行
mvn spring-boot:run
```

**启动成功标志：**
```
Started ExamRegistrationSystemApplication in X.XXX seconds
```

**后端服务地址：** http://localhost:8080/api

### 3. 启动前端服务

```bash
# 进入前端目录
cd frontend

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev

# 或使用 Vite 命令
npx vite
```

**启动成功标志：**
```
  VITE v4.x.x  ready in XXX ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: use --host to expose
```

**前端服务地址：** http://localhost:5173

---

## API 文档访问

### Swagger UI

后端启动成功后，访问以下地址查看 API 文档：

**Swagger UI:** http://localhost:8080/api/swagger-ui.html

**OpenAPI JSON:** http://localhost:8080/api/v3/api-docs

### API 概览

| 模块 | 接口数量 | 主要功能 |
|------|---------|----------|
| **用户认证** | 2 | 注册、登录 |
| **考试管理** | 8 | CRUD、发布、查询 |
| **报名管理** | 8 | 提交报名、审核、查询 |
| **支付订单** | 10 | 创建订单、支付、退款、统计 |
| **数据统计** | 8 | 仪表盘、趋势分析、按考试统计 |
| **公告管理** | 5 | CRUD、查询 |

---

## 功能测试

### 测试账号

| 角色 | 用户名 | 密码 | 描述 |
|------|--------|------|------|
| **管理员** | admin | admin123 | 系统管理员 |
| **考生** | 13800138000 | 123456 | 张三 |

### 测试流程

#### 1. 考生端测试流程

```
登录系统 (13800138000 / 123456)
    ↓
查看可报名考试列表
    ↓
选择考试并报名
    ├─ 选择考试
    ├─ 选择考点
    ├─ 填写个人信息（身份证号、手机号）
    └─ 确认提交
    ↓
等待管理员审核
    ↓
审核通过后进入支付页面
    ↓
选择支付方式（Mock支付）
    ↓
确认支付（点击即成功）
    ↓
获取准考证号
    ↓
查看我的报名记录
    ↓
查看缴费记录
```

#### 2. 管理员端测试流程

```
登录系统 (admin / admin123)
    ↓
查看数据统计仪表盘
    ├─ 考试总数
    ├─ 报名总数
    ├─ 缴费总额
    └─ 用户总数
    ↓
管理考试
    ├─ 创建新考试
    ├─ 设置报名时间
    ├─ 添加考点
    └─ 发布考试
    ↓
审核报名
    ├─ 查看待审核列表
    ├─ 查看报名详情（解密后的敏感信息）
    ├─ 审核通过 / 驳回
    └─ 自动创建支付订单（审核通过时）
    ↓
查看缴费管理
    ├─ 订单列表
    ├─ 缴费统计
    └─ 按考试统计
    ↓
查看数据统计
    ├─ 报名趋势图
    ├─ 缴费趋势图
    └─ 按考试详细统计
```

### API 测试示例

#### 使用 Swagger UI 测试

1. 访问 http://localhost:8080/api/swagger-ui.html
2. 点击 `POST /api/v1/users/login` 接口
3. 点击 `Try it out`
4. 输入登录信息：
   ```json
   {
     "username": "admin",
     "password": "admin123"
   }
   ```
5. 点击 `Execute`
6. 复制返回的 token
7. 点击页面右上角 `Authorize` 按钮
8. 输入：`Bearer {刚复制的token}`
9. 点击 `Authorize`
10. 现在可以测试需要认证的接口

#### 使用 cURL 测试

```bash
# 1. 登录获取 token
curl -X POST http://localhost:8080/api/v1/users/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 2. 使用 token 查询统计数据
curl -X GET http://localhost:8080/api/v1/statistics/dashboard \
  -H "Authorization: Bearer {刚获取的token}"

# 3. 提交报名（考生）
curl -X POST http://localhost:8080/api/v1/registrations \
  -H "Authorization: Bearer {考生的token}" \
  -H "Content-Type: application/json" \
  -d '{
    "examId": 1,
    "examSiteId": 1,
    "idCard": "110101199001011234",
    "phone": "13800138000",
    "subject": "计算机科学与技术"
  }'

# 4. 审核报名（管理员）
curl -X PUT http://localhost:8080/api/v1/registrations/1/audit \
  -H "Authorization: Bearer {管理员token}" \
  -H "Content-Type: application/json" \
  -d '{
    "auditStatus": 2,
    "auditRemark": "审核通过"
  }'

# 5. 执行支付
curl -X POST http://localhost:8080/api/v1/payments/pay \
  -H "Authorization: Bearer {考生的token}" \
  -H "Content-Type: application/json" \
  -d '{
    "orderNo": "PO20241018123456123456",
    "paymentMethod": "mock"
  }'
```

---

## 常见问题

### 1. 后端启动失败：端口 8080 被占用

**问题：** `Port 8080 was already in use`

**解决方案：**

```bash
# 查找占用端口的进程
lsof -i:8080

# 杀死进程
kill -9 <PID>

# 或者修改 application.yml 中的端口
server:
  port: 8081
```

### 2. 数据库连接失败

**问题：** `Communications link failure`

**检查清单：**

- [ ] MySQL 容器是否运行：`docker-compose ps`
- [ ] 数据库密码是否正确：`123456`
- [ ] 数据库名称是否正确：`exam_registration_system`
- [ ] 端口是否正确：`3306`

**解决方案：**

```bash
# 重启 MySQL 容器
docker-compose restart mysql

# 查看 MySQL 日志
docker-compose logs mysql

# 测试连接
docker-compose exec mysql mysql -uroot -p123456 -e "SELECT 1;"
```

### 3. 前端无法连接后端

**问题：** `Network Error` 或 `CORS Error`

**检查清单：**

- [ ] 后端是否启动：访问 http://localhost:8080/api/swagger-ui.html
- [ ] 前端代理配置是否正确（vite.config.ts）
- [ ] 后端 CORS 配置是否允许前端域名

**解决方案：**

检查 `frontend/vite.config.ts`:
```typescript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
      }
    }
  }
})
```

### 4. Swagger UI 显示空白

**问题：** Swagger 页面加载但没有 API 列表

**解决方案：**

- 确认 `springdoc-openapi-ui` 依赖已正确添加
- 检查 `application.yml` 中的 Swagger 配置
- 确认 SecurityConfig 允许 Swagger URL 访问
- 重启后端服务

### 5. JWT Token 过期

**问题：** `401 Unauthorized`

**解决方案：**

- 重新登录获取新 token
- 检查 `application.yml` 中的 JWT 过期时间配置（默认 7 天）
- 在 Swagger UI 中更新 Authorization

### 6. Mock 支付失败

**问题：** 点击支付后显示失败

**检查清单：**

- [ ] 报名是否已审核通过
- [ ] 支付订单是否已创建
- [ ] 订单是否已过期（30分钟）
- [ ] 订单状态是否正确（待支付）

---

## 测试数据说明

### 初始化数据

系统已预置以下测试数据（在 `sql/init.sql` 中）：

- **用户**：1 个管理员 + 1 个考生
- **考试**：暂无（需要管理员手动创建）
- **考点**：暂无（需要管理员手动创建）
- **报名记录**：暂无
- **支付订单**：暂无

### 创建测试考试

登录管理员账号后，可以通过以下步骤创建测试考试：

1. 访问考试管理页面
2. 点击"新增考试"
3. 填写考试信息：
   - 考试名称：2025年成人高考
   - 考试类型：统考
   - 考试日期：2025-10-24
   - 报名时间：设置为当前时间到未来某个时间
   - 报名费：100 元
4. 保存并发布考试
5. 添加考点（至少 1 个）

---

## 性能测试建议

### 并发测试

使用 JMeter 或 ab 进行并发测试：

```bash
# Apache Bench 示例（需要先安装 ab）
ab -n 1000 -c 50 -H "Authorization: Bearer {token}" \
   http://localhost:8080/api/v1/exams/available
```

### 目标指标

- 并发用户：500
- 响应时间：< 3 秒
- 错误率：< 1%

---

## 日志查看

### 后端日志

- **控制台输出**：直接在 IDE 或命令行中查看
- **日志级别**：DEBUG（开发环境）
- **关键日志**：
  - 用户登录/注册
  - 报名提交/审核
  - 支付订单创建/支付

### 前端日志

- **浏览器控制台**：按 F12 打开开发者工具
- **Network 面板**：查看 API 请求和响应
- **Console 面板**：查看错误信息

---

## 下一步

完成功能测试后，建议：

1. 运行单元测试：`mvn test`
2. 查看测试覆盖率报告
3. 进行压力测试
4. 准备毕业设计答辩演示

---

**文档版本：** v1.0
**最后更新：** 2024-10-18
**维护者：** 系统管理员
