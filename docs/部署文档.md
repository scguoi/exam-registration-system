# éƒ¨ç½²æ–‡æ¡£

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²åœ¨çº¿è€ƒè¯•æŠ¥åç³»ç»Ÿã€‚

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
- [æ•°æ®åº“éƒ¨ç½²](#æ•°æ®åº“éƒ¨ç½²)
- [åç«¯éƒ¨ç½²](#åç«¯éƒ¨ç½²)
- [å‰ç«¯éƒ¨ç½²](#å‰ç«¯éƒ¨ç½²)
- [Nginx é…ç½®](#nginx-é…ç½®)
- [è¿ç»´ç›‘æ§](#è¿ç»´ç›‘æ§)

---

## ç³»ç»Ÿæ¶æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Nginx (80/443) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                             â”‚
         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
         â”‚ å‰ç«¯é™æ€  â”‚                  â”‚ åç«¯API  â”‚
         â”‚ æ–‡ä»¶æœåŠ¡  â”‚                  â”‚  (8080)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                           â”‚
                                      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
                                      â”‚  MySQL  â”‚
                                      â”‚  (3306)  â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç¯å¢ƒå‡†å¤‡

### æœåŠ¡å™¨é…ç½®è¦æ±‚

**æœ€ä½é…ç½®ï¼ˆå¼€å‘/æµ‹è¯•ï¼‰ï¼š**
- CPU: 2æ ¸
- å†…å­˜: 4GB
- ç¡¬ç›˜: 50GB
- æ“ä½œç³»ç»Ÿ: Ubuntu 20.04 / CentOS 7+

**æ¨èé…ç½®ï¼ˆç”Ÿäº§ï¼‰ï¼š**
- CPU: 4æ ¸
- å†…å­˜: 8GB
- ç¡¬ç›˜: 100GB SSD
- æ“ä½œç³»ç»Ÿ: Ubuntu 22.04 / CentOS 8+

### å¿…éœ€è½¯ä»¶

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y  # Ubuntu
# æˆ–
sudo yum update -y  # CentOS

# å®‰è£… JDK 11
sudo apt install openjdk-11-jdk -y

# å®‰è£… Node.js 16+
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt install -y nodejs

# å®‰è£… MySQL 8.0
sudo apt install mysql-server -y

# å®‰è£… Nginx
sudo apt install nginx -y

# å®‰è£… Git
sudo apt install git -y
```

---

## æ•°æ®åº“éƒ¨ç½²

### 1. MySQL å®‰è£…é…ç½®

```bash
# å¯åŠ¨ MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# å®‰å…¨é…ç½®
sudo mysql_secure_installation
```

æŒ‰ç…§æç¤ºè¿›è¡Œå®‰å…¨é…ç½®ï¼š
- è®¾ç½® root å¯†ç ï¼ˆæ¨èå¼ºå¯†ç ï¼‰
- åˆ é™¤åŒ¿åç”¨æˆ·ï¼šY
- ç¦æ­¢ root è¿œç¨‹ç™»å½•ï¼šYï¼ˆæ¨èï¼‰
- åˆ é™¤testæ•°æ®åº“ï¼šY
- é‡æ–°åŠ è½½æƒé™è¡¨ï¼šY

### 2. åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·

```sql
-- ç™»å½• MySQL
sudo mysql -uroot -p

-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE exam_registration_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- åˆ›å»ºä¸“ç”¨ç”¨æˆ·ï¼ˆç”Ÿäº§ç¯å¢ƒä¸ä½¿ç”¨rootï¼‰
CREATE USER 'exam_user'@'localhost' IDENTIFIED BY 'your_strong_password';

-- æˆæƒ
GRANT ALL PRIVILEGES ON exam_registration_system.* TO 'exam_user'@'localhost';
FLUSH PRIVILEGES;

-- é€€å‡º
EXIT;
```

### 3. å¯¼å…¥æ•°æ®åº“ç»“æ„

```bash
# ä» Git ä»“åº“è·å– SQL æ–‡ä»¶
cd /opt
sudo git clone https://github.com/scguoi/exam-registration-system.git

# å¯¼å…¥æ•°æ®åº“
sudo mysql -uexam_user -p exam_registration_system < /opt/exam-registration-system/sql/init.sql
```

### 4. æ•°æ®åº“ä¼˜åŒ–é…ç½®

ç¼–è¾‘ MySQL é…ç½®æ–‡ä»¶ï¼š

```bash
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
```

æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```ini
[mysqld]
# å­—ç¬¦é›†
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci

# æ€§èƒ½ä¼˜åŒ–
max_connections=500
innodb_buffer_pool_size=512M
innodb_log_file_size=128M

# æ…¢æŸ¥è¯¢æ—¥å¿—
slow_query_log=1
slow_query_log_file=/var/log/mysql/slow.log
long_query_time=2
```

é‡å¯ MySQLï¼š

```bash
sudo systemctl restart mysql
```

---

## åç«¯éƒ¨ç½²

### 1. å…‹éš†é¡¹ç›®

```bash
cd /opt/exam-registration-system
sudo git pull origin main
```

### 2. ä¿®æ”¹é…ç½®æ–‡ä»¶

ç¼–è¾‘ `backend/src/main/resources/application-prod.yml`ï¼š

```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/exam_registration_system?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: exam_user
    password: your_strong_password
    driver-class-name: com.mysql.cj.jdbc.Driver

# JWT é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ›´é•¿çš„å¯†é’¥ï¼‰
jwt:
  secret: your-production-jwt-secret-key-must-be-at-least-64-characters-long-for-hs512
  expiration: 604800

# æ—¥å¿—é…ç½®
logging:
  level:
    com.exam: info  # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ info
    org.springframework.security: warn
  file:
    name: /var/log/exam-system/application.log
    max-size: 100MB
    max-history: 30
```

### 3. ç¼–è¯‘æ‰“åŒ…

```bash
cd /opt/exam-registration-system/backend

# å®‰è£…ä¾èµ–å¹¶æ‰“åŒ…
sudo mvn clean package -DskipTests -Pprod

# ç”Ÿæˆçš„ JAR æ–‡ä»¶ä½äº
# target/exam-registration-system-1.0.0.jar
```

### 4. åˆ›å»ºç³»ç»ŸæœåŠ¡

åˆ›å»º systemd æœåŠ¡æ–‡ä»¶ï¼š

```bash
sudo nano /etc/systemd/system/exam-backend.service
```

å†…å®¹å¦‚ä¸‹ï¼š

```ini
[Unit]
Description=Exam Registration System Backend
After=syslog.target network.target mysql.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/exam-registration-system/backend
ExecStart=/usr/bin/java -jar -Dspring.profiles.active=prod /opt/exam-registration-system/backend/target/exam-registration-system-1.0.0.jar
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š

```bash
# é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# å¯åŠ¨åç«¯æœåŠ¡
sudo systemctl start exam-backend

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable exam-backend

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status exam-backend

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u exam-backend -f
```

---

## å‰ç«¯éƒ¨ç½²

### 1. ä¿®æ”¹é…ç½®

ç¼–è¾‘ `frontend/.env.production`ï¼š

```bash
# API åœ°å€ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
VITE_API_BASE_URL=https://api.yourdom.com

# å…¶ä»–é…ç½®
VITE_APP_TITLE=åœ¨çº¿è€ƒè¯•æŠ¥åç³»ç»Ÿ
```

ç¼–è¾‘ `frontend/src/services/api.ts`ï¼Œç¡®ä¿ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ­£ç¡®çš„ BASE_URLï¼š

```typescript
const BASE_URL = import.meta.env.VITE_API_BASE_URL || '/api';
```

### 2. æ„å»ºå‰ç«¯

```bash
cd /opt/exam-registration-system/frontend

# å®‰è£…ä¾èµ–
sudo npm install

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
sudo npm run build

# æ„å»ºäº§ç‰©ä½äº dist/ ç›®å½•
```

### 3. å¤åˆ¶åˆ° Nginx ç›®å½•

```bash
# åˆ›å»º Nginx ç«™ç‚¹ç›®å½•
sudo mkdir -p /var/www/exam-system

# å¤åˆ¶æ„å»ºäº§ç‰©
sudo cp -r /opt/exam-registration-system/frontend/dist/* /var/www/exam-system/

# è®¾ç½®æƒé™
sudo chown -R www-data:www-data /var/www/exam-system
sudo chmod -R 755 /var/www/exam-system
```

---

## Nginx é…ç½®

### 1. åˆ›å»º Nginx ç«™ç‚¹é…ç½®

```bash
sudo nano /etc/nginx/sites-available/exam-system
```

å†…å®¹å¦‚ä¸‹ï¼š

```nginx
# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    # Let's Encrypt éªŒè¯è·¯å¾„
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # é‡å®šå‘åˆ° HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS é…ç½®
server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    # SSL è¯ä¹¦é…ç½®ï¼ˆä½¿ç”¨ Let's Encryptï¼‰
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # SSL å®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;

    # å‰ç«¯é™æ€æ–‡ä»¶
    root /var/www/exam-system;
    index index.html;

    # Gzip å‹ç¼©
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # å‰ç«¯è·¯ç”±ï¼ˆSPAï¼‰
    location / {
        try_files $uri $uri/ /index.html;
    }

    # åç«¯ API ä»£ç†
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket æ”¯æŒï¼ˆå¦‚æœéœ€è¦ï¼‰
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
}
```

### 2. å¯ç”¨ç«™ç‚¹é…ç½®

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/exam-system /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½ Nginx
sudo systemctl reload nginx
```

### 3. é…ç½® SSL è¯ä¹¦ï¼ˆLet's Encryptï¼‰

```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx -y

# è·å–è¯ä¹¦
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# è¯ä¹¦è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

---

## è¿ç»´ç›‘æ§

### 1. æ—¥å¿—ç®¡ç†

```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
sudo mkdir -p /var/log/exam-system

# åç«¯æ—¥å¿—
sudo tail -f /var/log/exam-system/application.log

# Nginx è®¿é—®æ—¥å¿—
sudo tail -f /var/nginx/access.log

# Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# ç³»ç»ŸæœåŠ¡æ—¥å¿—
sudo journalctl -u exam-backend -f
```

### 2. æ—¥å¿—è½®è½¬

åˆ›å»º `logrotate` é…ç½®ï¼š

```bash
sudo nano /etc/logrotate.d/exam-system
```

å†…å®¹ï¼š

```
/var/log/exam-system/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        systemctl reload exam-backend > /dev/null 2>&1 || true
    endscript
}
```

### 3. æ•°æ®åº“å¤‡ä»½

åˆ›å»ºå¤‡ä»½è„šæœ¬ï¼š

```bash
sudo nano /opt/scripts/backup-database.sh
```

å†…å®¹ï¼š

```bash
#!/bin/bash

# é…ç½®
DB_NAME="exam_registration_system"
DB_USER="exam_user"
DB_PASS="your_strong_password"
BACKUP_DIR="/opt/backups/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/${DB_NAME}_${DATE}.sql.gz

# åˆ é™¤30å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete

echo "Database backup completed: ${DB_NAME}_${DATE}.sql.gz"
```

è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š

```bash
sudo chmod +x /opt/scripts/backup-database.sh

# ç¼–è¾‘ crontab
sudo crontab -e

# æ·»åŠ æ¯å¤©å‡Œæ™¨3ç‚¹å¤‡ä»½
0 3 * * * /opt/scripts/backup-database.sh >> /var/log/exam-system/backup.log 2>&1
```

### 4. ç³»ç»Ÿç›‘æ§

å®‰è£…ç›‘æ§å·¥å…·ï¼ˆå¯é€‰ï¼‰ï¼š

```bash
# å®‰è£… htop
sudo apt install htop -y

# å®‰è£… iftopï¼ˆç½‘ç»œç›‘æ§ï¼‰
sudo apt install iftop -y

# å®‰è£… iotopï¼ˆç£ç›˜ç›‘æ§ï¼‰
sudo apt install iotop -y
```

### 5. å¥åº·æ£€æŸ¥è„šæœ¬

```bash
sudo nano /opt/scripts/health-check.sh
```

å†…å®¹ï¼š

```bash
#!/bin/bash

# æ£€æŸ¥åç«¯æœåŠ¡
if systemctl is-active --quiet exam-backend; then
    echo "âœ“ Backend service is running"
else
    echo "âœ— Backend service is down"
    sudo systemctl start exam-backend
fi

# æ£€æŸ¥ MySQL
if systemctl is-active --quiet mysql; then
    echo "âœ“ MySQL is running"
else
    echo "âœ— MySQL is down"
    sudo systemctl start mysql
fi

# æ£€æŸ¥ Nginx
if systemctl is-active --quiet nginx; then
    echo "âœ“ Nginx is running"
else
    echo "âœ— Nginx is down"
    sudo systemctl start nginx
fi

# æ£€æŸ¥ç£ç›˜ç©ºé—´
DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "âš  Disk usage is high: ${DISK_USAGE}%"
fi
```

è®¾ç½®å®šæ—¶å¥åº·æ£€æŸ¥ï¼š

```bash
sudo chmod +x /opt/scripts/health-check.sh

# æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
*/5 * * * * /opt/scripts/health-check.sh >> /var/log/exam-system/health-check.log 2>&1
```

---

## å¸¸ç”¨è¿ç»´å‘½ä»¤

### æœåŠ¡ç®¡ç†

```bash
# åç«¯æœåŠ¡
sudo systemctl start exam-backend      # å¯åŠ¨
sudo systemctl stop exam-backend       # åœæ­¢
sudo systemctl restart exam-backend    # é‡å¯
sudo systemctl status exam-backend     # æŸ¥çœ‹çŠ¶æ€

# MySQL
sudo systemctl start mysql
sudo systemctl stop mysql
sudo systemctl restart mysql

# Nginx
sudo systemctl start nginx
sudo systemctl stop nginx
sudo systemctl reload nginx  # é‡æ–°åŠ è½½é…ç½®ï¼ˆæ¨èï¼‰
```

### æ›´æ–°éƒ¨ç½²

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
cd /opt/exam-registration-system
sudo git pull origin main

# 2. æ›´æ–°åç«¯
cd backend
sudo mvn clean package -DskipTests -Pprod
sudo systemctl restart exam-backend

# 3. æ›´æ–°å‰ç«¯
cd ../frontend
sudo npm run build
sudo cp -r dist/* /var/www/exam-system/
sudo systemctl reload nginx
```

---

## å®‰å…¨åŠ å›º

### 1. é˜²ç«å¢™é…ç½®

```bash
# å¯ç”¨ UFW
sudo ufw enable

# å…è®¸ SSH
sudo ufw allow 22/tcp

# å…è®¸ HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

### 2. MySQL å®‰å…¨

```bash
# ç¦æ­¢ root è¿œç¨‹ç™»å½•
# ä»…å…è®¸æœ¬åœ°è¿æ¥
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
```

æ·»åŠ ï¼š

```ini
[mysqld]
bind-address = 127.0.0.1
```

### 3. å®šæœŸæ›´æ–°

```bash
# è®¾ç½®è‡ªåŠ¨å®‰å…¨æ›´æ–°
sudo apt install unattended-upgrades -y
sudo dpkg-reconfigure -plow unattended-upgrades
```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2024-10-18
