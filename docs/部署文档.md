# 部署文档

本文档介绍如何在生产环境部署在线考试报名系统。

## 📋 目录

- [系统架构](#系统架构)
- [环境准备](#环境准备)
- [数据库部署](#数据库部署)
- [后端部署](#后端部署)
- [前端部署](#前端部署)
- [Nginx 配置](#nginx-配置)
- [运维监控](#运维监控)

---

## 系统架构

```
                    ┌─────────────────┐
                    │  Nginx (80/443) │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
         ┌────▼────┐                  ┌────▼────┐
         │ 前端静态  │                  │ 后端API  │
         │ 文件服务  │                  │  (8080)  │
         └─────────┘                  └────┬────┘
                                           │
                                      ┌────▼────┐
                                      │  MySQL  │
                                      │  (3306)  │
                                      └─────────┘
```

## 环境准备

### 服务器配置要求

**最低配置（开发/测试）：**
- CPU: 2核
- 内存: 4GB
- 硬盘: 50GB
- 操作系统: Ubuntu 20.04 / CentOS 7+

**推荐配置（生产）：**
- CPU: 4核
- 内存: 8GB
- 硬盘: 100GB SSD
- 操作系统: Ubuntu 22.04 / CentOS 8+

### 必需软件

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y  # Ubuntu
# 或
sudo yum update -y  # CentOS

# 安装 JDK 11
sudo apt install openjdk-11-jdk -y

# 安装 Node.js 16+
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt install -y nodejs

# 安装 MySQL 8.0
sudo apt install mysql-server -y

# 安装 Nginx
sudo apt install nginx -y

# 安装 Git
sudo apt install git -y
```

---

## 数据库部署

### 1. MySQL 安装配置

```bash
# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

按照提示进行安全配置：
- 设置 root 密码（推荐强密码）
- 删除匿名用户：Y
- 禁止 root 远程登录：Y（推荐）
- 删除test数据库：Y
- 重新加载权限表：Y

### 2. 创建数据库和用户

```sql
-- 登录 MySQL
sudo mysql -uroot -p

-- 创建数据库
CREATE DATABASE exam_registration_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建专用用户（生产环境不使用root）
CREATE USER 'exam_user'@'localhost' IDENTIFIED BY 'your_strong_password';

-- 授权
GRANT ALL PRIVILEGES ON exam_registration_system.* TO 'exam_user'@'localhost';
FLUSH PRIVILEGES;

-- 退出
EXIT;
```

### 3. 导入数据库结构

```bash
# 从 Git 仓库获取 SQL 文件
cd /opt
sudo git clone https://github.com/scguoi/exam-registration-system.git

# 导入数据库
sudo mysql -uexam_user -p exam_registration_system < /opt/exam-registration-system/sql/init.sql
```

### 4. 数据库优化配置

编辑 MySQL 配置文件：

```bash
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
```

添加以下配置：

```ini
[mysqld]
# 字符集
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci

# 性能优化
max_connections=500
innodb_buffer_pool_size=512M
innodb_log_file_size=128M

# 慢查询日志
slow_query_log=1
slow_query_log_file=/var/log/mysql/slow.log
long_query_time=2
```

重启 MySQL：

```bash
sudo systemctl restart mysql
```

---

## 后端部署

### 1. 克隆项目

```bash
cd /opt/exam-registration-system
sudo git pull origin main
```

### 2. 修改配置文件

编辑 `backend/src/main/resources/application-prod.yml`：

```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/exam_registration_system?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: exam_user
    password: your_strong_password
    driver-class-name: com.mysql.cj.jdbc.Driver

# JWT 配置（生产环境使用更长的密钥）
jwt:
  secret: your-production-jwt-secret-key-must-be-at-least-64-characters-long-for-hs512
  expiration: 604800

# 日志配置
logging:
  level:
    com.exam: info  # 生产环境使用 info
    org.springframework.security: warn
  file:
    name: /var/log/exam-system/application.log
    max-size: 100MB
    max-history: 30
```

### 3. 编译打包

```bash
cd /opt/exam-registration-system/backend

# 安装依赖并打包
sudo mvn clean package -DskipTests -Pprod

# 生成的 JAR 文件位于
# target/exam-registration-system-1.0.0.jar
```

### 4. 创建系统服务

创建 systemd 服务文件：

```bash
sudo nano /etc/systemd/system/exam-backend.service
```

内容如下：

```ini
[Unit]
Description=Exam Registration System Backend
After=syslog.target network.target mysql.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/exam-registration-system/backend
ExecStart=/usr/bin/java -jar -Dspring.profiles.active=prod /opt/exam-registration-system/backend/target/exam-registration-system-1.0.0.jar
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
# 重新加载 systemd
sudo systemctl daemon-reload

# 启动后端服务
sudo systemctl start exam-backend

# 设置开机自启
sudo systemctl enable exam-backend

# 查看状态
sudo systemctl status exam-backend

# 查看日志
sudo journalctl -u exam-backend -f
```

---

## 前端部署

### 1. 修改配置

编辑 `frontend/.env.production`：

```bash
# API 地址（生产环境）
VITE_API_BASE_URL=https://api.yourdom.com

# 其他配置
VITE_APP_TITLE=在线考试报名系统
```

编辑 `frontend/src/services/api.ts`，确保生产环境使用正确的 BASE_URL：

```typescript
const BASE_URL = import.meta.env.VITE_API_BASE_URL || '/api';
```

### 2. 构建前端

```bash
cd /opt/exam-registration-system/frontend

# 安装依赖
sudo npm install

# 构建生产版本
sudo npm run build

# 构建产物位于 dist/ 目录
```

### 3. 复制到 Nginx 目录

```bash
# 创建 Nginx 站点目录
sudo mkdir -p /var/www/exam-system

# 复制构建产物
sudo cp -r /opt/exam-registration-system/frontend/dist/* /var/www/exam-system/

# 设置权限
sudo chown -R www-data:www-data /var/www/exam-system
sudo chmod -R 755 /var/www/exam-system
```

---

## Nginx 配置

### 1. 创建 Nginx 站点配置

```bash
sudo nano /etc/nginx/sites-available/exam-system
```

内容如下：

```nginx
# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    # Let's Encrypt 验证路径
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 重定向到 HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS 配置
server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    # SSL 证书配置（使用 Let's Encrypt）
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;

    # 前端静态文件
    root /var/www/exam-system;
    index index.html;

    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # 前端路由（SPA）
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 后端 API 代理
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
}
```

### 2. 启用站点配置

```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/exam-system /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重新加载 Nginx
sudo systemctl reload nginx
```

### 3. 配置 SSL 证书（Let's Encrypt）

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取证书
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 证书自动续期
sudo certbot renew --dry-run
```

---

## 运维监控

### 1. 日志管理

```bash
# 创建日志目录
sudo mkdir -p /var/log/exam-system

# 后端日志
sudo tail -f /var/log/exam-system/application.log

# Nginx 访问日志
sudo tail -f /var/nginx/access.log

# Nginx 错误日志
sudo tail -f /var/log/nginx/error.log

# 系统服务日志
sudo journalctl -u exam-backend -f
```

### 2. 日志轮转

创建 `logrotate` 配置：

```bash
sudo nano /etc/logrotate.d/exam-system
```

内容：

```
/var/log/exam-system/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        systemctl reload exam-backend > /dev/null 2>&1 || true
    endscript
}
```

### 3. 数据库备份

创建备份脚本：

```bash
sudo nano /opt/scripts/backup-database.sh
```

内容：

```bash
#!/bin/bash

# 配置
DB_NAME="exam_registration_system"
DB_USER="exam_user"
DB_PASS="your_strong_password"
BACKUP_DIR="/opt/backups/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/${DB_NAME}_${DATE}.sql.gz

# 删除30天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete

echo "Database backup completed: ${DB_NAME}_${DATE}.sql.gz"
```

设置定时任务：

```bash
sudo chmod +x /opt/scripts/backup-database.sh

# 编辑 crontab
sudo crontab -e

# 添加每天凌晨3点备份
0 3 * * * /opt/scripts/backup-database.sh >> /var/log/exam-system/backup.log 2>&1
```

### 4. 系统监控

安装监控工具（可选）：

```bash
# 安装 htop
sudo apt install htop -y

# 安装 iftop（网络监控）
sudo apt install iftop -y

# 安装 iotop（磁盘监控）
sudo apt install iotop -y
```

### 5. 健康检查脚本

```bash
sudo nano /opt/scripts/health-check.sh
```

内容：

```bash
#!/bin/bash

# 检查后端服务
if systemctl is-active --quiet exam-backend; then
    echo "✓ Backend service is running"
else
    echo "✗ Backend service is down"
    sudo systemctl start exam-backend
fi

# 检查 MySQL
if systemctl is-active --quiet mysql; then
    echo "✓ MySQL is running"
else
    echo "✗ MySQL is down"
    sudo systemctl start mysql
fi

# 检查 Nginx
if systemctl is-active --quiet nginx; then
    echo "✓ Nginx is running"
else
    echo "✗ Nginx is down"
    sudo systemctl start nginx
fi

# 检查磁盘空间
DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "⚠ Disk usage is high: ${DISK_USAGE}%"
fi
```

设置定时健康检查：

```bash
sudo chmod +x /opt/scripts/health-check.sh

# 每5分钟检查一次
*/5 * * * * /opt/scripts/health-check.sh >> /var/log/exam-system/health-check.log 2>&1
```

---

## 常用运维命令

### 服务管理

```bash
# 后端服务
sudo systemctl start exam-backend      # 启动
sudo systemctl stop exam-backend       # 停止
sudo systemctl restart exam-backend    # 重启
sudo systemctl status exam-backend     # 查看状态

# MySQL
sudo systemctl start mysql
sudo systemctl stop mysql
sudo systemctl restart mysql

# Nginx
sudo systemctl start nginx
sudo systemctl stop nginx
sudo systemctl reload nginx  # 重新加载配置（推荐）
```

### 更新部署

```bash
# 1. 拉取最新代码
cd /opt/exam-registration-system
sudo git pull origin main

# 2. 更新后端
cd backend
sudo mvn clean package -DskipTests -Pprod
sudo systemctl restart exam-backend

# 3. 更新前端
cd ../frontend
sudo npm run build
sudo cp -r dist/* /var/www/exam-system/
sudo systemctl reload nginx
```

---

## 安全加固

### 1. 防火墙配置

```bash
# 启用 UFW
sudo ufw enable

# 允许 SSH
sudo ufw allow 22/tcp

# 允许 HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 查看状态
sudo ufw status
```

### 2. MySQL 安全

```bash
# 禁止 root 远程登录
# 仅允许本地连接
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
```

添加：

```ini
[mysqld]
bind-address = 127.0.0.1
```

### 3. 定期更新

```bash
# 设置自动安全更新
sudo apt install unattended-upgrades -y
sudo dpkg-reconfigure -plow unattended-upgrades
```

---

**文档版本：** v1.0
**最后更新：** 2024-10-18
